# Amplify State Issues Troubleshooting

## Problem: Missing aws-exports.js or App Won't Build

### Symptoms

- Build error: `Unable to resolve "../aws-exports" from "src/amplify-config.ts"`
- App crashes on startup
- No AWS configuration found

### Why This Happens

Several Amplify files are **intentionally gitignored** because they:

1. Contain environment-specific information
2. Are generated from the deployed backend
3. Should not be committed to version control

**Gitignored files:**

- `aws-exports.js` - AWS Amplify configuration (API endpoints, keys, region)
- `amplify/#current-cloud-backend/` - Deployed backend state
- `amplify/.config/local-env-info.json` - Local environment configuration

These files can be deleted by:

- Running `git clean -fd` (removes all untracked files)
- Switching branches
- Fresh clone of the repository

### Quick Fix

Run the restore script:

```bash
yarn amplify:restore
```

This script will:

1. ✅ Create `amplify/.config/local-env-info.json`
2. ✅ Recreate `amplify/#current-cloud-backend/` directory
3. ✅ Create `amplify/#current-cloud-backend/amplify-meta.json`
4. ✅ Generate `aws-exports.js` from deployed backend (requires AWS CLI + amplify-user profile)

**If the script can't fetch API details:**

```bash
# Alternative: Use amplify status to generate files
yarn amplify:status
```

### Manual Fix (If Script Fails)

<details>
<summary>Expand for manual steps</summary>

#### Step 1: Create `amplify/.config/local-env-info.json`

```json
{
  "projectPath": "/path/to/orion-task-system",
  "defaultEditor": "code",
  "envName": "dev"
}
```

#### Step 2: Copy backend to current-cloud-backend

```bash
mkdir -p amplify/#current-cloud-backend
cp -r amplify/backend/* amplify/#current-cloud-backend/
```

#### Step 3: Create `amplify/#current-cloud-backend/amplify-meta.json`

Get values from `amplify/team-provider-info.json` and create:

```json
{
  "providers": {
    "awscloudformation": {
      "AuthRoleName": "amplify-lxtodoapp-dev-50e3d-authRole",
      "UnauthRoleArn": "arn:aws:iam::377973420769:role/amplify-lxtodoapp-dev-50e3d-unauthRole",
      "AuthRoleArn": "arn:aws:iam::377973420769:role/amplify-lxtodoapp-dev-50e3d-authRole",
      "Region": "us-east-1",
      "DeploymentBucketName": "amplify-lxtodoapp-dev-50e3d-deployment",
      "UnauthRoleName": "amplify-lxtodoapp-dev-50e3d-unauthRole",
      "StackName": "amplify-lxtodoapp-dev-50e3d",
      "StackId": "arn:aws:cloudformation:us-east-1:377973420769:stack/amplify-lxtodoapp-dev-50e3d/...",
      "AmplifyAppId": "d2vty117li92m8"
    }
  },
  "api": {
    "oriontasksystem": {
      "service": "AppSync",
      "providerPlugin": "awscloudformation",
      "output": {
        "authConfig": {
          "defaultAuthentication": {
            "authenticationType": "API_KEY",
            "apiKeyConfig": {
              "apiKeyExpirationDays": 7
            }
          }
        }
      }
    }
  }
}
```

#### Step 4: Get AppSync details and create `aws-exports.js`

Run `amplify status` to get the GraphQL endpoint and API key, then create:

```javascript
/* eslint-disable */
// WARNING: DO NOT EDIT. This file is automatically generated by AWS Amplify. It will be overwritten.

const awsmobile = {
  aws_project_region: "us-east-1",
  aws_appsync_graphqlEndpoint:
    "https://YOUR-API-ID.appsync-api.us-east-1.amazonaws.com/graphql",
  aws_appsync_region: "us-east-1",
  aws_appsync_authenticationType: "API_KEY",
  aws_appsync_apiKey: "da2-YOUR-API-KEY",
  aws_appsync_dangerously_connect_to_http_endpoint_for_testing: false,
};

export default awsmobile;
```

</details>

---

## Prevention: Git Operations Best Practices

### ⚠️ When Running `git clean`

**NEVER run `git clean -fd` without thinking!**

It deletes ALL untracked files, including:

- `aws-exports.js`
- `amplify/#current-cloud-backend/`
- `amplify/.config/`
- Any other gitignored files

**Instead:**

```bash
# Option 1: Only remove specific directories
rm -rf coverage/ dist/ build/

# Option 2: Do a dry run first to see what would be deleted
git clean -fdn

# Option 3: Use git clean with exclusions
git clean -fd -e aws-exports.js -e amplify/#current-cloud-backend
```

### ✅ After Switching Branches

If the app fails to build after switching branches:

```bash
yarn amplify:restore
```

### ✅ After Fresh Clone

After cloning the repo for the first time:

```bash
yarn install
yarn amplify:restore
# or
yarn amplify:status
```

---

## Why These Files Are Gitignored

### Security

- `aws-exports.js` contains API keys and endpoints
- Should not be committed to public repositories

### Environment-Specific

- Different developers may have different local Amplify state
- Different environments (dev/staging/prod) have different configs

### Generated Files

- These files are automatically generated by Amplify
- Should be regenerated from the source of truth (deployed backend)

---

## Related Scripts

| Script                                    | Purpose                                       |
| ----------------------------------------- | --------------------------------------------- |
| `yarn amplify:restore`                    | Restore all Amplify state files (recommended) |
| `yarn amplify:status`                     | Show Amplify status and regenerate files      |
| `AWS_PROFILE=amplify-user amplify status` | Manual Amplify status check                   |

---

## When to Run Each Script

| Situation                | Command                |
| ------------------------ | ---------------------- |
| After `git clean -fd`    | `yarn amplify:restore` |
| After switching branches | `yarn amplify:restore` |
| After fresh clone        | `yarn amplify:restore` |
| AWS config seems wrong   | `yarn amplify:status`  |
| Debugging Amplify issues | `yarn amplify:status`  |

---

## Still Having Issues?

1. **Check AWS CLI is installed:**

   ```bash
   aws --version
   ```

2. **Check AWS profile exists:**

   ```bash
   aws configure list-profiles | grep amplify-user
   ```

3. **Check AWS credentials work:**

   ```bash
   AWS_PROFILE=amplify-user aws sts get-caller-identity
   ```

4. **Check Amplify backend is deployed:**

   ```bash
   AWS_PROFILE=amplify-user aws cloudformation list-stacks --region us-east-1 | grep amplify-lxtodoapp-dev
   ```

5. **Ask for help with specific error messages**
