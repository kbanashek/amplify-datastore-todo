# Native Build Fixes

Since the `ios/` and `android/` directories are not committed (they're generated by Expo), we need to apply these fixes after running `expo prebuild` or when setting up the project.

## Required Fixes

### 1. iOS: Duplicate Symbols Fix (JKBigInteger/JKBigDecimal)

**Problem:** Both `AmplifyRTNCore` and `RNAWSCognito` include the same `JKBigInteger` and `JKBigDecimal` classes, causing duplicate symbol linker errors.

**Solution:** Exclude the `.m` implementation files from `RNAWSCognito` compilation since they're already provided by `AmplifyRTNCore`.

**Location:** `ios/Podfile` - Add to the `post_install` block

**Fix Code:**

```ruby
# Fix duplicate symbols between AmplifyRTNCore and RNAWSCognito (JKBigInteger/JKBigDecimal)
# Both libraries include the same JKBigInteger/JKBigDecimal classes, causing linker errors
# Solution: Use build settings to exclude the .m files and script phase to remove object files
installer.pods_project.targets.each do |target|
  if target.name == 'RNAWSCognito'
    target.build_configurations.each do |config|
      # Exclude JKBigInteger and JKBigDecimal .m files using build settings
      excluded_files = config.build_settings['EXCLUDED_SOURCE_FILE_NAMES'] || []
      excluded_files << 'JKBigInteger.m'
      excluded_files << 'JKBigDecimal.m'
      config.build_settings['EXCLUDED_SOURCE_FILE_NAMES'] = excluded_files.uniq
    end

    # Also remove from source build phase as backup
    files_to_remove = []
    target.source_build_phase.files.each do |file|
      if file.file_ref
        file_name = file.file_ref.path || file.file_ref.name || file.file_ref.display_name
        if file_name && (file_name.include?('JKBigInteger.m') || file_name.include?('JKBigDecimal.m'))
          files_to_remove << file
        end
      end
    end
    files_to_remove.each do |file|
      target.source_build_phase.remove_file_reference(file.file_ref)
    end

    # Add script phase to remove object files from built library as final backup
    existing_script = target.build_phases.find { |p| p.is_a?(Xcodeproj::Project::Object::PBXShellScriptBuildPhase) && p.name == 'Remove Duplicate JKBigInteger Symbols' }
    target.build_phases.delete(existing_script) if existing_script

    script_phase = target.new_shell_script_build_phase('Remove Duplicate JKBigInteger Symbols')
    script_phase.shell_script = <<-SCRIPT
      # Remove duplicate JKBigInteger and JKBigDecimal object files from RNAWSCognito
      # These are already provided by AmplifyRTNCore
      LIB_PATH="${BUILT_PRODUCTS_DIR}/libRNAWSCognito.a"
      if [ -f "$LIB_PATH" ]; then
        # Extract object files, remove duplicates, and recreate library
        TEMP_DIR=$(mktemp -d)
        cd "$TEMP_DIR"
        ar -x "$LIB_PATH" 2>/dev/null || true
        # Remove JKBigInteger and JKBigDecimal object files
        rm -f JKBigInteger.o JKBigDecimal.o 2>/dev/null || true
        # Recreate library without duplicates (only if we removed files)
        if [ -n "$(ls -A *.o 2>/dev/null)" ]; then
          ar -rcs "$LIB_PATH" *.o 2>/dev/null || true
        fi
        cd - > /dev/null
        rm -rf "$TEMP_DIR"
      fi
    SCRIPT
    script_phase.run_only_for_deployment_postprocessing = '0'
  end
end
```

**Where to add:** Insert this code in the `post_install do |installer|` block, before the final `end` of that block.

### 2. Android: MainActivity onCreate Fix

**Problem:** `MainActivity.onCreate()` passes `null` instead of `savedInstanceState`, causing Expo dev launcher timing issues.

**Solution:** Change `super.onCreate(null)` to `super.onCreate(savedInstanceState)`.

**Location:** `android/app/src/main/java/com/orion/tasksystem/MainActivity.kt`

**Fix:** Change line 23 from:

```kotlin
super.onCreate(null)
```

to:

```kotlin
super.onCreate(savedInstanceState)
```

## Applying the Fixes

### Option 1: Use the Automated Script

Run the script after `expo prebuild` or when setting up the project:

```bash
./scripts/apply-native-fixes.sh
```

Then for iOS:

```bash
cd ios && pod install
```

### Option 2: Manual Application

1. **iOS:** Open `ios/Podfile` and add the fix code to the `post_install` block (see above)
2. **Android:** Open `android/app/src/main/java/com/orion/tasksystem/MainActivity.kt` and change `super.onCreate(null)` to `super.onCreate(savedInstanceState)`

### Option 3: After Expo Prebuild

If you run `expo prebuild`, you'll need to apply these fixes afterward:

```bash
expo prebuild
./scripts/apply-native-fixes.sh
cd ios && pod install
```

## When to Apply

- After running `expo prebuild` for the first time
- After cloning the repository and setting up native projects
- After Expo updates that regenerate native code
- When iOS builds fail with duplicate symbol errors
- When Android crashes with "App react context shouldn't be created before" error

## Verification

**iOS:** Build should complete without duplicate symbol errors for `JKBigInteger`/`JKBigDecimal`

**Android:** App should launch without the React context timing error
