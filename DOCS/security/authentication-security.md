# Authentication Security Documentation

**Last Updated**: 2025-01-04  
**Status**: Active  
**Applies To**: All environments (Development, Testing, Production)

## Overview

This document outlines the authentication security strategy for the Orion Task System, including current implementation, security considerations, and differences between testing and production environments.

## Current Authentication Method

### API Key Authentication

The application currently uses **AWS AppSync API Key authentication** for all DataStore operations. This is configured in `src/amplify-config.ts`:

```typescript
aws_appsync_authenticationType: "API_KEY"
aws_appsync_apiKey: awsconfig.aws_appsync_apiKey
```

### Configuration Location

- **Primary Config**: `aws-exports.js` (generated by Amplify CLI)
- **Initialization**: `src/amplify-config.ts` → `configureAmplify()`
- **Bootstrap**: `src/bootstrap/taskSystemBootstrap.ts`

## Security Considerations

### API Key Authentication (Current)

**✅ Advantages:**
- Simple to implement and test
- No user sign-in required
- Fast development cycle
- Easy cross-device sync testing

**⚠️ Security Risks:**
- **Public Access**: API keys are embedded in client code and can be extracted
- **No User Identity**: Cannot track which user performed which action
- **Limited Authorization**: All authenticated clients have same permissions
- **Key Rotation**: Rotating keys requires redeploying all client apps
- **Compliance**: May not meet HIPAA, GDPR, or other regulatory requirements

### Current Status: Testing Only

**This authentication method is ONLY suitable for:**
- ✅ Local development
- ✅ Internal testing
- ✅ Proof-of-concept demos
- ❌ **NOT suitable for production with real patient data**

## Production Security Requirements

### Required Changes for Production

1. **User Authentication**
   - Implement AWS Cognito User Pools
   - Add user sign-in/sign-up flows
   - Enable Multi-Factor Authentication (MFA)
   - Implement password policies

2. **Authorization**
   - Implement role-based access control (RBAC)
   - Define user roles: Patient, Clinician, Researcher, Admin
   - Implement fine-grained permissions per role
   - Add row-level security for data isolation

3. **Data Isolation**
   - Ensure users can only access their own data
   - Implement organization-level data partitioning
   - Add study-level access controls
   - Enforce patient data privacy

4. **Audit & Compliance**
   - Log all data access and modifications
   - Track user actions with user IDs
   - Implement audit trail for compliance
   - Enable CloudWatch logging for security monitoring

## Migration Path to Production Security

### Phase 1: Add Cognito Authentication

```typescript
// Update amplify-config.ts
Amplify.configure({
  ...awsconfig,
  Auth: {
    region: awsconfig.aws_cognito_region,
    userPoolId: awsconfig.aws_user_pools_id,
    userPoolWebClientId: awsconfig.aws_user_pools_web_client_id,
  },
  aws_appsync_authenticationType: "AMAZON_COGNITO_USER_POOLS",
});
```

### Phase 2: Implement Authorization

```graphql
# Update GraphQL schema with authorization rules
type Task @model 
  @auth(rules: [
    { allow: owner, operations: [create, read, update, delete] }
    { allow: groups, groups: ["Clinicians"], operations: [read] }
  ]) {
  id: ID!
  owner: String
  # ... other fields
}
```

### Phase 3: Add User Management UI

- Sign In / Sign Up screens
- Password reset flow
- Profile management
- Session management

### Phase 4: Testing & Validation

- Security penetration testing
- HIPAA compliance audit (if applicable)
- User acceptance testing
- Load testing with authentication

## Development vs Production

### Development Environment

```typescript
// Current setup (API_KEY) - DEVELOPMENT ONLY
aws_appsync_authenticationType: "API_KEY"
```

**Characteristics:**
- Public API key (committed to repo)
- No user authentication required
- Shared data access across all devices
- Fast iteration for development

**⚠️ WARNING**: Never use this configuration with real patient data or in production.

### Production Environment

```typescript
// Required for production (COGNITO USER POOLS)
aws_appsync_authenticationType: "AMAZON_COGNITO_USER_POOLS"
```

**Characteristics:**
- User authentication required
- Each user has unique identity
- Data isolated per user/organization
- Audit trail with user attribution
- Compliance-ready

## Security Best Practices

### Current Implementation

1. **API Key Rotation**
   - Rotate API keys regularly (every 90 days minimum)
   - Use separate keys for dev/staging/prod
   - Never commit production keys to version control

2. **Environment Separation**
   - Use separate AWS accounts for dev/staging/prod
   - Implement network isolation
   - Restrict API key access via IP allowlist (if possible)

3. **Monitoring**
   - Monitor API usage for anomalies
   - Set up CloudWatch alarms for unusual patterns
   - Track failed authentication attempts

### Future Production Implementation

1. **Authentication**
   - Enforce strong password policies (12+ chars, complexity)
   - Require MFA for all users handling sensitive data
   - Implement session timeouts (15-30 minutes)
   - Use secure token storage (secure enclave on mobile)

2. **Authorization**
   - Principle of least privilege
   - Regular access reviews
   - Automatic role assignment based on user attributes

3. **Data Protection**
   - Encrypt data at rest (AWS KMS)
   - Encrypt data in transit (TLS 1.3)
   - Implement data retention policies
   - Enable point-in-time recovery

4. **Compliance**
   - HIPAA compliance for healthcare data
   - GDPR compliance for EU users
   - Regular security audits
   - Penetration testing (annually)

## Validation Checklist

### Before Deploying to Production

- [ ] Cognito User Pools configured
- [ ] User authentication flows implemented
- [ ] Authorization rules defined in GraphQL schema
- [ ] Row-level security tested
- [ ] MFA enabled for sensitive operations
- [ ] Audit logging enabled
- [ ] Security scan completed (no high/critical vulnerabilities)
- [ ] Penetration test passed
- [ ] Compliance audit passed (if applicable)
- [ ] Data encryption verified (at rest and in transit)
- [ ] Incident response plan documented
- [ ] Security training completed for development team

## Input Validation

### Service Layer Validation (Implemented)

The application now includes Zod schema validation at the service layer to prevent invalid data from reaching the DataStore:

**Location**: `packages/task-system/src/validation/taskSchemas.ts`

**Coverage**:
- ✅ Task creation input validation
- ✅ Task update input validation  
- ✅ Task ID format validation (UUID)
- ✅ Task filters validation
- ✅ Time range validation
- ✅ Field length validation

**Example**:
```typescript
// TaskService automatically validates all inputs
const task = await TaskService.createTask({
  title: "Patient Survey",
  taskType: TaskType.SCHEDULED,
  // ... validation happens automatically
});
```

**Validation Errors**:
```typescript
try {
  await TaskService.createTask(invalidData);
} catch (error) {
  if (error instanceof ValidationError) {
    console.error("Validation failed:", error.issues);
    // [{ path: "title", message: "Title is required" }]
  }
}
```

## Additional Security Layers Needed

### 1. Client-Side Validation
- Add UI-level validation before service calls
- Provide user-friendly error messages
- Prevent invalid data entry

### 2. API Gateway Validation
- Add AWS API Gateway request validators
- Rate limiting per client
- IP-based access controls

### 3. Backend Business Logic Validation
- Lambda resolvers for complex validation
- Cross-field validation rules
- Business rule enforcement

## References

- [AWS AppSync Security](https://docs.aws.amazon.com/appsync/latest/devguide/security.html)
- [AWS Cognito User Pools](https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html)
- [AWS Amplify Authentication](https://docs.amplify.aws/lib/auth/getting-started/q/platform/js/)
- [HIPAA Compliance on AWS](https://aws.amazon.com/compliance/hipaa-compliance/)
- [Zod Validation Library](https://zod.dev/)

## Contact

For security concerns or questions, contact:
- **Security Lead**: [Contact Information]
- **DevOps Team**: [Contact Information]
- **Compliance Officer**: [Contact Information]

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-01-04 | Initial security documentation created | System |
| 2025-01-04 | Added Zod validation implementation | System |
