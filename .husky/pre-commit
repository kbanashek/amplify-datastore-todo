#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ“¦ Checking yarn integrity..."
yarn check --integrity || {
  echo "âŒ Yarn integrity check failed. Please run 'yarn install' to fix dependency issues."
  echo "ğŸ’¡ This prevents committing with broken dependencies or lockfile mismatches."
  exit 1
}

echo "âœ… Yarn integrity check passed!"

echo "ğŸ”’ Verifying yarn.lock is synchronized with package.json..."
# Check if package.json was modified but yarn.lock wasn't updated
if git diff --cached --name-only | grep -q "package.json" && ! git diff --cached --name-only | grep -q "yarn.lock"; then
  echo "âš ï¸  WARNING: package.json is staged but yarn.lock is not."
  echo "ğŸ’¡ If you modified dependencies, run 'yarn install' to update yarn.lock."
  echo "ğŸ’¡ If this is intentional (e.g., only version bump), you can proceed."
fi

# Verify lockfile is actually in sync by checking if yarn would modify it
if ! yarn install --check-files --frozen-lockfile > /dev/null 2>&1; then
  echo "âŒ Yarn lockfile is out of sync with package.json."
  echo "ğŸ’¡ Please run 'yarn install' to update yarn.lock before committing."
  exit 1
fi

echo "âœ… Yarn lockfile is synchronized!"

echo "ğŸ” Running lint..."
# Run lint and capture output, fail on any warnings or errors
LINT_OUTPUT=$(yarn lint 2>&1)
LINT_EXIT_CODE=$?

# Check if lint command failed (errors)
if [ $LINT_EXIT_CODE -ne 0 ]; then
  echo "$LINT_OUTPUT"
  echo "âŒ Lint failed with errors. Please fix linting errors before committing."
  exit 1
fi

# Check if there are any lint warnings in the output (even if exit code is 0)
# Look for actual lint warnings (format: "path:line:col warning message")
# Ignore ESLint deprecation warnings and other system warnings
if echo "$LINT_OUTPUT" | grep -qE "^[^/]*/[^:]+:[0-9]+:[0-9]+\s+warning"; then
  echo "$LINT_OUTPUT"
  echo "âŒ Lint warnings detected. Please fix all linting warnings before committing."
  echo "ğŸ’¡ Run 'yarn lint --fix' to auto-fix some issues."
  exit 1
fi

echo "âœ… Lint passed with no warnings or errors!"

echo "ğŸ’… Running format check..."
yarn format:check || {
  echo "âŒ Format check failed. Please run 'yarn format' to fix formatting."
  exit 1
}

echo "âœ… Format check passed!"

echo "ğŸ”„ Checking for circular dependencies..."
yarn check:circular || {
  echo "âŒ Circular dependencies detected. Please fix them before committing."
  echo "ğŸ’¡ Run 'yarn check:circular' to see the circular dependency graph."
  exit 1
}

echo "âœ… No circular dependencies found!"
echo "âœ… All pre-commit checks passed!"



