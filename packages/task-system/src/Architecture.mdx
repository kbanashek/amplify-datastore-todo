import { Meta } from "@storybook/blocks";

<Meta title="Architecture" />

# Architecture Overview

This document describes the architecture and design decisions of the Orion Task System.

## ğŸ—ï¸ Project Structure

```
packages/task-system/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/          # React components
â”‚   â”‚   â”œâ”€â”€ ui/             # Base UI components
â”‚   â”‚   â”œâ”€â”€ questions/      # Question type components
â”‚   â”‚   â”œâ”€â”€ TaskCard.tsx    # Domain components
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ hooks/              # Custom React hooks
â”‚   â”‚   â”œâ”€â”€ useTaskList.ts
â”‚   â”‚   â”œâ”€â”€ useLogger.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ services/           # Business logic services
â”‚   â”‚   â”œâ”€â”€ TaskService.ts
â”‚   â”‚   â”œâ”€â”€ LoggingService.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ utils/              # Utility functions
â”‚   â”‚   â”œâ”€â”€ taskIcon.ts
â”‚   â”‚   â”œâ”€â”€ dateUtils.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ types/              # TypeScript types
â”‚   â”‚   â”œâ”€â”€ Task.ts
â”‚   â”‚   â”œâ”€â”€ Question.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ constants/          # App constants
â”‚   â”‚   â”œâ”€â”€ AppColors.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ translations/       # i18n translations
â”‚   â”‚   â”œâ”€â”€ en.json
â”‚   â”‚   â””â”€â”€ config/
â”‚   â””â”€â”€ models/            # AWS DataStore models
â””â”€â”€ .storybook/            # Storybook configuration
```

## ğŸ§© Component Architecture

### Separation of Concerns

Components follow a strict separation between presentation and logic:

**Components** (Presentation Layer)
- Handle rendering and user interactions
- Should be small and focused (~200 lines max)
- Delegate all business logic to hooks

**Hooks** (Logic Layer)
- Contain all state management
- Handle side effects (`useEffect`, subscriptions)
- Implement business logic
- Provide event handlers

**Services** (Data Layer)
- Interact with AWS DataStore
- Provide CRUD operations
- Handle error cases
- Manage data transformations

### Example Pattern

```typescript
// âŒ BAD: Logic in component
export default function MyComponent() {
  const [state, setState] = useState(...);
  useEffect(() => { ... }, []);
  const handleSubmit = async () => { ... };
  // 500+ lines of logic and JSX
}

// âœ… GOOD: Separated concerns

// hooks/useMyComponent.ts
export const useMyComponent = () => {
  const [state, setState] = useState(...);
  useEffect(() => { ... }, []);
  const handleSubmit = async () => { ... };
  return { state, handleSubmit, ... };
};

// components/MyComponent.tsx
export const MyComponent = () => {
  const { state, handleSubmit } = useMyComponent();
  return <View>...</View>;
};
```

## ğŸ”„ Data Flow

### AWS Amplify DataStore

The system uses AWS Amplify DataStore for data persistence and sync:

```
User Interaction
    â†“
Component Event Handler
    â†“
Custom Hook
    â†“
Service Layer
    â†“
AWS DataStore
    â†“
Cloud Sync (when online)
```

### Real-Time Updates

Components subscribe to DataStore changes for real-time updates:

```typescript
// In a custom hook
useEffect(() => {
  const subscription = DataStore.observe(Task).subscribe(
    ({ element, opType }) => {
      // Handle real-time updates
      if (opType === "INSERT") {
        // Add new task to list
      } else if (opType === "UPDATE") {
        // Update existing task
      } else if (opType === "DELETE") {
        // Remove task from list
      }
    }
  );

  return () => subscription.unsubscribe();
}, []);
```

## ğŸ¨ Design System

### Color System

Two color systems are available:
- **AppColors** - Primary color system (preferred)
- **Colors** - Theme-aware colors (light/dark mode)

```typescript
import { AppColors } from "@constants/AppColors";

const styles = StyleSheet.create({
  container: {
    backgroundColor: AppColors.powderGray,
    borderColor: AppColors.CIBlue,
  },
});
```

### Typography

Use the `ThemedText` component for consistent typography:

```typescript
<ThemedText type="title">Heading</ThemedText>
<ThemedText type="default">Body text</ThemedText>
<ThemedText type="link">Clickable link</ThemedText>
```

### Spacing

Use consistent spacing based on 4px or 8px increments:
- Small: 8px
- Medium: 16px
- Large: 24px
- XLarge: 32px

## ğŸŒ Internationalization

### i18next Integration

All user-facing text uses i18next for translations:

```typescript
import { useTaskTranslation } from "@translations/index";

const { t } = useTaskTranslation();

// Usage
<Text>{t("task.begin")}</Text>
<Text>{t("common.save")}</Text>
```

### Translation Files

Translations are organized by namespace:

```json
// translations/en.json
{
  "common": {
    "save": "Save",
    "cancel": "Cancel"
  },
  "task": {
    "begin": "Begin",
    "resume": "Resume",
    "completed": "Completed"
  }
}
```

## ğŸ“ Logging System

### Centralized Logging

All logging goes through the `LoggingService`:

```typescript
// In React components/hooks
import { useLogger } from "@hooks/useLogger";
const logger = useLogger();

logger.info("Task loaded", { taskId }, "TaskList", "DATA-1", "ğŸ“‹");
logger.error("Failed to load task", error, "TaskList");

// In services/utilities
import { getLoggingService } from "@services/LoggingService";
const logger = getLoggingService().createLogger("TaskService");

logger.info("Task created", { taskId }, "CREATE", "âœ…");
```

### Log Format

Logs follow a consistent format:
```
[ICON] [PLATFORM] [STEP] ServiceName: Message
```

Example:
```
ğŸ“‹ [iOS] [DATA-1] TaskList: Loaded 5 tasks (synced-with-cloud)
```

## ğŸ§ª Testing Strategy

### Test Organization

Tests are colocated with source files:

```
src/
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useTaskList.ts
â”‚   â””â”€â”€ __tests__/
â”‚       â””â”€â”€ useTaskList.test.ts
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ TaskService.ts
â”‚   â””â”€â”€ __tests__/
â”‚       â””â”€â”€ TaskService.test.ts
â””â”€â”€ components/
    â”œâ”€â”€ TaskCard.tsx
    â””â”€â”€ __tests__/
        â””â”€â”€ TaskCard.test.tsx
```

### Test Coverage

- **Hooks**: Test state changes, side effects, and edge cases
- **Services**: Test all public methods and error handling
- **Components**: Test rendering, interactions, and props
- **Utils**: Test all functions with edge cases

## ğŸ” Type Safety

### TypeScript Best Practices

- **No `any` types** - Use proper types, `unknown`, or generics
- **Explicit return types** - All functions have return types
- **Strict null checks** - Handle `null` and `undefined` explicitly
- **Type guards** - Use type guards instead of type assertions

```typescript
// âŒ Bad
function process(data: any) {
  return data.value;
}

// âœ… Good
function process<T extends { value: string }>(data: T): string {
  return data.value;
}

// âœ… Good error handling
catch (error: unknown) {
  const message = error instanceof Error 
    ? error.message 
    : String(error);
  logger.error("Failed", message);
}
```

## ğŸ“¦ Package Exports

The package exports components, hooks, services, and types:

```typescript
// From package root (src/index.ts)
export { Button, Card, TextField } from "./components/ui";
export { TaskCard, AppointmentCard } from "./components";
export { useTaskList, useLogger } from "./hooks";
export { TaskService } from "./services";
export type { Task, Question } from "./types";
```

## ğŸš€ Build System

### TypeScript Compilation

The package uses TypeScript for compilation:

```bash
# Build command
yarn build

# Output
dist/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ Button.js
â”‚   â”‚   â”œâ”€â”€ Button.d.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ ...
â””â”€â”€ index.js
```

### Module Resolution

Path aliases simplify imports:

```typescript
// Instead of
import { Task } from "../../types/Task";

// Use
import { Task } from "@task-types/Task";
```

## ğŸ”„ State Management

### Local State

Use React hooks for component-level state:
- `useState` for simple state
- `useReducer` for complex state logic
- `useMemo` for computed values
- `useCallback` for stable callbacks

### Global State

DataStore subscriptions provide global real-time state:
- Components subscribe to DataStore changes
- Updates propagate automatically
- No need for Redux or MobX

## ğŸ“± Platform Support

The package supports:
- **iOS** - Native iOS apps
- **Android** - Native Android apps
- **Web** - React Native Web (via Storybook)

Platform-specific code uses `Platform.select`:

```typescript
import { Platform } from "react-native";

const styles = StyleSheet.create({
  text: {
    ...Platform.select({
      ios: { fontFamily: "System" },
      android: { fontFamily: "Roboto" },
      web: { fontFamily: "system-ui" },
    }),
  },
});
```

## ğŸ¯ Design Goals

1. **Reusability** - Components can be used in multiple contexts
2. **Composability** - Combine simple components into complex ones
3. **Type Safety** - Full TypeScript coverage
4. **Testability** - All code has unit tests
5. **Accessibility** - WCAG compliant
6. **Performance** - Optimized for mobile devices
7. **Maintainability** - Clean, documented code

