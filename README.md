# Amplify DataStore Todo App

A React Native Todo application built with Expo and AWS Amplify that demonstrates online/offline synchronization capabilities using DataStore with SQLite as the storage adapter.

## Features

- Create and manage todos with real-time updates
- Offline-first architecture with seamless synchronization
- Visual indicators for network and sync status
- TypeScript implementation for type safety
- AWS AppSync backend integration

## Prerequisites

- Node.js (v14 or later)
- npm or yarn
- Expo CLI (`npm install -g expo-cli`)
- AWS Account (for backend services)
- AWS Amplify CLI (`npm install -g @aws-amplify/cli`)

## Setup Instructions

### 1. Clone the repository

```bash
git clone <repository-url>
cd amplify-datastore-todo
```

### 2. Install dependencies

```bash
npm install
```

### 3. Pull the existing Amplify backend

```bash
amplify pull --appId d19l3dxjz56ge3 --envName dev
```

Follow the prompts to configure the Amplify backend. This will create the necessary `aws-exports.js` file.

### 4. Start the app

```bash
npm start
```

In the output, you'll find options to open the app in a:

- [Android emulator](https://docs.expo.dev/workflow/android-studio-emulator/)
- [iOS simulator](https://docs.expo.dev/workflow/ios-simulator/)
- [Expo Go](https://expo.dev/go) on your physical device
## Project Structure

```
/amplify-datastore-todo
├── app/                    # Expo Router app directory
│   ├── (tabs)/            # Tab-based navigation
│   │   └── index.tsx      # Main screen with TodoForm and TodoList
│   └── _layout.tsx        # App layout configuration
├── models/                # Amplify generated models
├── src/
│   ├── amplify-config.ts  # Amplify configuration
│   ├── API.ts            # Generated TypeScript types from GraphQL schema
│   ├── components/        # UI components
│   │   ├── NetworkStatusIndicator.tsx
│   │   ├── TodoForm.tsx
│   │   └── TodoList.tsx
│   ├── contexts/
│   │   └── AmplifyContext.tsx  # Amplify context provider
│   ├── graphql/          # Generated GraphQL operations
│   │   ├── mutations.ts  # GraphQL mutation operations
│   │   ├── queries.ts    # GraphQL query operations
│   │   └── subscriptions.ts # GraphQL subscription operations
│   ├── hooks/            # Custom React hooks
│   │   ├── useAmplifyState.ts # Amplify state management
│   │   ├── useNetworkStatus.ts # Network status logic
│   │   ├── useTodoForm.ts # Todo form logic
│   │   └── useTodoList.ts # Todo list logic
│   └── services/
│       └── TodoService.ts  # Todo CRUD operations
└── aws-exports.js         # AWS configuration (generated by Amplify CLI)
```

## Testing Offline Functionality

1. Create a few todos while online
2. Turn off your device's network connection (airplane mode or disable Wi-Fi/cellular)
3. Create more todos while offline
4. Turn your network connection back on
5. Watch as the sync indicator changes and your offline todos sync with the backend

## Troubleshooting

- If you encounter issues with DataStore synchronization, try clearing the local database:
  ```javascript
  // In your app code, add this for testing:
  await DataStore.clear();
  ```

- Ensure you have the latest version of the Amplify CLI installed

## Amplify Codegen

This project uses AWS Amplify's codegen feature to automatically generate TypeScript types and GraphQL operations from the GraphQL schema. The configuration is in `.graphqlconfig.yml`.

### Generated Files

- **`src/API.ts`**: Contains TypeScript interfaces for all GraphQL types, including:
  - Model interfaces (Todo)
  - Input types (CreateTodoInput, UpdateTodoInput, DeleteTodoInput)
  - Query/Mutation response types
  - Enums and scalars

- **`src/graphql/`**: Contains GraphQL operation strings:
  - `queries.ts`: GraphQL query operations (getTodo, listTodos)
  - `mutations.ts`: GraphQL mutation operations (createTodo, updateTodo, deleteTodo)
  - `subscriptions.ts`: GraphQL subscription operations (onCreateTodo, onUpdateTodo, onDeleteTodo)

### Benefits

- **Type Safety**: Full TypeScript typing for all GraphQL operations
- **Automatic Updates**: When the schema changes, running codegen updates all types and operations
- **Reduced Boilerplate**: No need to manually write GraphQL operations
- **Consistency**: Ensures all operations follow the same patterns

### Updating Generated Files

If you modify the GraphQL schema, run:

```bash
amplify codegen
```

## AWS Architecture Overview

This application uses several AWS technologies working together to provide a seamless offline-first experience. Here's an explanation of the key components and how they interact:

### Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                      React Native App                           │
│                                                                 │
│  ┌───────────────┐    ┌───────────────┐    ┌───────────────┐    │
│  │  Components   │    │    Hooks      │    │   Contexts    │    │
│  └───────┬───────┘    └───────┬───────┘    └───────┬───────┘    │
│          │                    │                    │            │
│          └────────────┬───────┴────────────┬──────┘            │
│                       │                    │                    │
│               ┌───────▼───────┐    ┌──────▼───────┐            │
│               │  TodoService  │    │AmplifyContext│            │
│               └───────┬───────┘    └──────┬───────┘            │
│                       │                    │                    │
└───────────────────────┼────────────────────┼────────────────────┘
                        │                    │
                ┌───────▼────────────────────▼───────┐
                │           DataStore                │
                │  ┌─────────────┐  ┌────────────┐  │
                │  │Local Storage│  │ Sync Engine│  │
                │  │  (SQLite)   │  │            │  │
                │  └─────────────┘  └──────┬─────┘  │
                └────────────────────────────┼───────┘
                                             │
                                    ┌────────▼────────┐
                                    │  AWS AppSync     │
                                    │  (GraphQL API)   │
                                    └────────┬─────────┘
                                             │
                                    ┌────────▼────────┐
                                    │  DynamoDB        │
                                    │  (Database)      │
                                    └─────────────────┘
```

### Key AWS Technologies

#### AWS Amplify

AWS Amplify is the framework that ties everything together. It provides:

- **CLI Tools**: For creating and managing backend resources
- **Client Libraries**: For connecting the React Native app to AWS services
- **Hosting**: For deploying web applications (not used in this mobile app)
- **Authentication**: For user management (not currently implemented but could be added)

In our app, Amplify is configured in `src/amplify-config.ts` and provides the connection to all AWS services.

#### AWS AppSync

AppSync is AWS's managed GraphQL service that acts as the API layer:

- **GraphQL API**: Provides a single endpoint for all data operations
- **Real-time Data**: Enables subscriptions for live updates
- **Schema Definition**: Defines the data model using GraphQL SDL
- **Resolvers**: Connect GraphQL operations to data sources

Our app uses AppSync as the backend API, with the schema defined in `amplify/backend/api/lxtodoapp/schema.graphql`.

#### DataStore

DataStore is Amplify's solution for offline-first data management:

- **Local Storage**: Persists data locally using SQLite
- **Sync Engine**: Handles synchronization with the cloud when online
- **Conflict Resolution**: Manages conflicts between local and remote changes
- **Real-time Updates**: Subscribes to changes and updates the UI

In our app, `TodoService.ts` uses DataStore for all data operations, enabling offline functionality.

#### How They Work Together

1. **User Interaction**: User interacts with React components
2. **Component Logic**: Components use hooks for business logic
3. **Data Operations**: Hooks call TodoService methods
4. **Local Storage**: DataStore saves changes to local SQLite database
5. **Background Sync**: When online, DataStore syncs with AppSync
6. **Cloud Storage**: AppSync persists data to DynamoDB
7. **Real-time Updates**: Changes from other devices come back through subscriptions

#### DataStore Conflict Resolution

This app implements a custom conflict resolution strategy for handling synchronization conflicts between local and remote changes:

```typescript
// Custom conflict handler in TodoService.ts
DataStore.configure({
  conflictHandler: async ({ modelConstructor, localModel, remoteModel, operation }) => {
    // For Todo model conflicts during updates
    if (modelConstructor.name === "Todo" && operation === OpType.UPDATE) {
      // Custom merge strategy: take local name, but remote description if it exists
      const resolvedModel = {
        ...remoteModel,                // Start with remote model as base
        name: localModel.name,        // Always prefer local name changes
        description: remoteModel.description !== localModel.description && 
                    remoteModel.description ? 
                    remoteModel.description : 
                    localModel.description
      };
      return resolvedModel;
    }
    
    // For delete operations, always accept local delete
    if (operation === OpType.DELETE) {
      return localModel;
    }
    
    // Default to remote model for other cases
    return remoteModel;
  }
});
```

**How Conflicts Are Handled:**

1. **Detection**: DataStore detects when the same record has been modified both locally and remotely
2. **Custom Logic**: Our conflict handler applies specific merge rules:
   - For updates to Todo items:
     - Always keep the local name changes
     - Use remote description if it exists and differs from local
   - For deletions: Always accept local deletions
   - For other cases: Default to remote changes
3. **Tracking**: The app tracks conflict occurrences via the `conflictCount` in `useAmplifyState`
4. **Logging**: All conflicts are logged to the console with details for debugging

### Other AWS Services Used

- **DynamoDB**: NoSQL database that stores the Todo data
- **IAM**: Manages permissions and access control
- **CloudFormation**: Provisions and manages AWS resources (used by Amplify CLI)
- **Lambda Functions**: While not directly visible in our code, AppSync can use Lambda functions for resolvers

#### AppSync Resolvers and Lambda

In our current implementation, AppSync uses default VTL (Velocity Template Language) resolvers to connect GraphQL operations to DynamoDB. These are not Lambda functions but rather template scripts that AppSync executes.

However, for more complex operations, you can configure AppSync to use Lambda functions as resolvers. This would allow you to:

- Implement complex business logic
- Integrate with other AWS services
- Perform data validation and transformation
- Access multiple data sources in a single operation

To add a Lambda resolver, you would use the Amplify CLI:

```bash
amplify add function
amplify update api # to connect the function as a resolver
```

### Potential Future AWS Integrations

#### Cognito Authentication Example

Here's how you could integrate Amazon Cognito for authentication (this code is for reference only and is commented out):

```typescript
// src/auth-config.ts
// NOTE: This is an example and is NOT currently implemented

import { Amplify, Auth } from 'aws-amplify';
import awsconfig from '../aws-exports';

// Configure Amplify with authentication
export const configureAmplifyWithAuth = () => {
  // Add auth configuration to existing config
  const authConfig = {
    ...awsconfig,
    oauth: {
      domain: 'your-cognito-domain.auth.region.amazoncognito.com',
      scope: ['email', 'profile', 'openid'],
      redirectSignIn: 'myapp://callback/',
      redirectSignOut: 'myapp://signout/',
      responseType: 'code'
    }
  };
  
  Amplify.configure(authConfig);
};

// Example auth hook
export const useAuth = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    // Check current auth state
    const checkUser = async () => {
      try {
        const userData = await Auth.currentAuthenticatedUser();
        setUser(userData);
      } catch (e) {
        setUser(null);
      } finally {
        setLoading(false);
      }
    };
    
    checkUser();
    
    // Listen for auth events
    const listener = Hub.listen('auth', ({ payload }) => {
      const { event } = payload;
      if (event === 'signIn') {
        checkUser();
      } else if (event === 'signOut') {
        setUser(null);
      }
    });
    
    return () => Hub.remove('auth', listener);
  }, []);
  
  const signIn = () => Auth.federatedSignIn();
  const signOut = () => Auth.signOut();
  
  return { user, loading, signIn, signOut };
};
```

To implement this, you would:

1. Run `amplify add auth` to add Cognito to your project
2. Configure authentication settings as needed
3. Integrate the auth hook into your app
4. Add protected routes based on authentication state

#### Other Potential AWS Integrations

- **S3**: For file storage (e.g., attaching images to todos)
- **CloudWatch**: For monitoring and logging
- **Pinpoint**: For analytics and push notifications
- **API Gateway**: For REST APIs if needed alongside GraphQL

## Learn More

- [AWS Amplify Documentation](https://docs.amplify.aws/)
- [Amplify Codegen Documentation](https://docs.amplify.aws/cli/graphql/codegen/)
- [DataStore Documentation](https://docs.amplify.aws/lib/datastore/getting-started/q/platform/js/)
- [AppSync Documentation](https://docs.aws.amazon.com/appsync/)
- [Expo Documentation](https://docs.expo.dev/)
